# If a handover from TCH/F to TCH/H frees a dynamic timeslot,
# take the freed TCH/H from the soure timeslot into account,
# both when the target is a dynamic timeslot and when the target is a static timeslot.

create-bts trx-count 1 timeslots c+s4 dyn TCH/F TCH/F TCH/H PDCH PDCH PDCH

network
 bts 0
  handover2 min-free-slots tch/f 3
  handover2 min-free-slots tch/h 2
  handover2 assignment 1

set-ts-use trx 0 0 states * TCH/F - - - * * *
# (there must be at least one measurement report on each lchan for congestion check to work)
meas-rep lchan * * * * rxlev 40 rxqual 0 ta 0 neighbors 30
congestion-check
# FAIL: after the handover from the dyn TS to TCH/H, the dyn TS has freed two TCH/H, while the static TCH/H has reduced
# the TCH/H count by one. So the resulting free slots are 3 TCH/H, which means no congestion. A handover should occur.
expect-no-chan

# Again with one more TCH/H occupied, there will still be two free TCH/H after HO on the dyn TS
set-ts-use trx 0 0 states * TCH/F - - TCH/H- * * *
meas-rep lchan * * * * rxlev 40 rxqual 0 ta 0 neighbors 30
congestion-check
# FAIL: resulting free slots are 2 TCH/H, which means no congestion. A handover should occur.
expect-no-chan

# Again, with the target being a dyn TS
create-bts trx-count 1 timeslots c+s4 dyn TCH/F TCH/F dyn PDCH PDCH PDCH

network
 bts 1
  handover2 min-free-slots tch/f 3
  handover2 min-free-slots tch/h 2
  handover2 assignment 1

set-ts-use trx 1 0 states * TCH/F TCH/F - pdch * * *
meas-rep lchan 1 * * * rxlev 40 rxqual 0 ta 0 neighbors 30
congestion-check
# FAIL: after the handover from the dyn TS to TCH/H, the dyn TS has freed two TCH/H, while the static TCH/H has reduced
# the TCH/H count by one. So the resulting free slots are 3 TCH/H, which means no congestion. A handover should occur.
expect-no-chan

# Again with one more TCH/H occupied, there will still be two free TCH/H after HO on the dyn TS
set-ts-use trx 1 0 states * TCH/F TCH/F - TCH/H- * * *
meas-rep lchan 1 * * * rxlev 40 rxqual 0 ta 0 neighbors 30
congestion-check
# FAIL: resulting free slots are 2 TCH/H, which means no congestion. A handover should occur.
expect-no-chan
